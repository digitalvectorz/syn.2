#!/bin/bash
TEMPLATE_SYN_DIR="/usr/share/syn/synd"

#if [ -e *deb ]; then
#	rm *deb
#fi

if [ -d rollup ]; then
	rm -rf rollup
fi

#apt-get download $1
mkdir rollup
mkdir rollup/crud
mkdir rollup/crud/synd
mkdir rollup/logs

dpkg-deb -x *.deb rollup/syn/
metainf=`dpkg-deb -I *.deb`

descr=`echo "$metainf"    | grep Description      | sed s/\ Description:\ //g`
maint=`echo "$metainf"    | grep Maintainer:      | sed s/\ Maintainer:\ //g`
pkg=`echo "$metainf"      | grep Package:         | sed s/\ Package:\ //g`
ver=`echo "$metainf"      | grep Version:         | sed s/\ Version:\ //g`
deps=`echo "$metainf"     | grep ^\ Depends:\     | sed s/\ Depends:\ //g     | sed -r 's/\(.[^)]*\)//g' | sed s/[\ ]*//g`
predeps=`echo "$metainf"  | grep ^\ Pre-Depends:\ | sed s/\ Pre-Depends:\ //g | sed -r 's/\(.[^)]*\)//g' | sed s/[\ ]*//g`
email=`echo $maint        | sed s/.*\<//g         | tr -d ">"`
name=`echo $maint         | sed s/\<.*\>//g`

if [ "x$predeps" != "x" ]; then
	# echo " Deps: Both pre and post root"
	deps="$deps,$predeps"
fi

JSONDeps="[\"`echo "$deps" | sed s/,/\\\",\\\"/g`\"]"

echo "Debian Import Log:"   > rollup/logs/import.log
echo ""                 >> rollup/logs/import.log
echo "Parsed Vals"      >> rollup/logs/import.log
echo ""                 >> rollup/logs/import.log
echo "Descr: $descr"    >> rollup/logs/import.log
echo "Maint: $maint"    >> rollup/logs/import.log
echo " Name: $name"     >> rollup/logs/import.log
echo "Email: $email"    >> rollup/logs/import.log
echo "Packg: $pkg"      >> rollup/logs/import.log
echo "Versn: $ver"      >> rollup/logs/import.log
echo " Deps: $JSONDeps" >> rollup/logs/import.log
echo ""                 >> rollup/logs/import.log

cd rollup
cat $TEMPLATE_SYN_DIR/meta | sed s/{PKG}/$pid/g | \
	sed s/{PKGNAME}/$pkg/g | \
	sed s/{PKGVER}/$ver/g > crud/synd/meta

cd crud
syn-dev --metaf "maintainer.name=$name"
syn-dev --metaf "description=$descr"
syn-dev --metaf "maintainer.email=$email"
syn-dev --metaf "deps=$JSONDeps"

syn-dev --bbuild .
cd ../ # crud
mv *.syn* ..
cd ..
rm -rf rollup
