#!/bin/bash
# Paul Tagliamonte, GPLv3, 2011
echo "Signing uploads."

if [ "x`ls *sigs 2>/dev/null`" != "x" ]; then
	echo "Sigs already present"
	echo "Checking if we need to resign"
	syn-verifyupload > /dev/null 2>&1

	if [ $? -ne 0 ]; then
		rm *sigs
		echo "invalid sig. resigning."
	else
		echo "valid sigs. quitting"
		exit 1
	fi
fi

syn-dev -s *.syn # generate sum. file

UPLOADS=`md5sum *.syn*`
PKG=`ls *.syn`
echo "$UPLOADS" > $PKG.sigs
echo "Running gpg clearsign on the upload validator"
gpg --clearsign $PKG.sigs
rm $PKG.sigs
mv $PKG.sigs.asc $PKG.sigs
